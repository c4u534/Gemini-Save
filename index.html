<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operation Offload: Intelligent Workspace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f3f4f6; }
        .chat-bubble-user { background-color: #1f2937; }
        .chat-bubble-ai { background-color: #374151; }
        .code-block { font-family: 'Roboto Mono', monospace; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .loading-dots {
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }
        .loading-dots::after {
            content: "";
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #10b981;
            animation: loading 1.4s infinite ease-in-out;
        }
        @keyframes loading {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-white">Operation Offload</h1>
            <p class="mt-2 max-w-2xl mx-auto text-lg text-gray-400">An intelligent workspace with automated artifact offloading to Google Drive.</p>
        </header>

        <div id="auth-section" class="bg-gray-800 shadow-xl rounded-lg p-6 mb-8 text-center">
            <h2 class="text-xl font-bold text-teal-400 mb-4">Authentication Status</h2>
            <p id="auth-status" class="text-yellow-400 mb-4">Initializing authentication...</p>
            <button id="authorize_button" disabled class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md disabled:bg-gray-500 disabled:cursor-not-allowed">Sign In with Google</button>
            <button id="signout_button" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Sign Out</button>
            <div id="drive-status" class="mt-2 text-sm text-gray-400"></div>
        </div>

        <div class="bg-gray-800 shadow-xl rounded-lg p-6">
            <!-- Download & Archive Controls -->
            <div id="archive-controls" class="hidden bg-gray-700 rounded-lg p-4 mb-4">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                    <h3 class="text-lg font-semibold text-white">üì¶ Archive & Download</h3>
                    <div class="flex flex-wrap gap-2">
                        <button id="download-current-chat" class="bg-purple-600 hover:bg-purple-700 text-white text-sm py-2 px-3 rounded disabled:bg-gray-500" disabled>üíæ Current Chat</button>
                        <button id="download-all-drive-content" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm py-2 px-3 rounded disabled:bg-gray-500" disabled>üìÅ All Drive Files</button>
                        <button id="bulk-download-interactions" class="bg-green-600 hover:bg-green-700 text-white text-sm py-2 px-3 rounded disabled:bg-gray-500" disabled>üóÇÔ∏è Bulk Export</button>
                        <button id="generate-summary-report" class="bg-yellow-600 hover:bg-yellow-700 text-white text-sm py-2 px-3 rounded disabled:bg-gray-500" disabled>üìä Summary Report</button>
                    </div>
                </div>
                <div id="download-progress" class="hidden">
                    <div class="bg-gray-600 rounded-full h-2 mb-2">
                        <div id="progress-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p id="progress-text" class="text-sm text-gray-300">Preparing download...</p>
                </div>
                <div id="download-status" class="text-sm text-gray-400"></div>
            </div>

            <div id="chat-window" class="h-96 overflow-y-auto bg-gray-900 p-4 rounded-lg border border-gray-700 mb-4 space-y-4">
                <div class="w-full flex justify-start">
                    <div class="p-3 rounded-lg max-w-[90%] chat-bubble-ai">
                        <p>Welcome to Operation Offload! I'm ready to help you create content that will be automatically saved to your Google Drive. Please authenticate first, then ask me anything!</p>
                    </div>
                </div>
            </div>

            <div class="flex items-center">
                <textarea id="prompt-input" class="flex-grow bg-gray-700 border-gray-600 rounded-l-md shadow-sm py-2 px-4 text-gray-200 focus:outline-none focus:ring-teal-500 focus:border-teal-500 resize-none" placeholder="Send a message..." rows="1" disabled></textarea>
                <button id="send-button" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-r-md self-stretch disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Send</button>
            </div>
        </div>
    </div>

    <!-- Load Google APIs -->
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script>
        // --- CONFIGURATION ---
        const CLIENT_ID = '700648198913-6itdi4jv7mhdhpq3ncqavndst36imo76.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCZIUCIhmX9H8Qr7PZJbkVu5Ue7ZOs-H9U';
        const GEMINI_API_KEY = 'AIzaSyCZIUCIhmX9H8Qr7PZJbkVu5Ue7ZOs-H9U'; // Using same key for Gemini
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const GEMINI_ENDPOINT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent';
        
        let DRIVE_FOLDER_ID = null;
        let conversationHistory = [];

        // --- UI ELEMENTS ---
        const authorizeButton = document.getElementById('authorize_button');
        const signoutButton = document.getElementById('signout_button');
        const authStatus = document.getElementById('auth-status');
        const driveStatus = document.getElementById('drive-status');
        const chatWindow = document.getElementById('chat-window');
        const promptInput = document.getElementById('prompt-input');
        const sendButton = document.getElementById('send-button');

        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let isProcessing = false;

        // --- INITIALIZATION ---
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
                });
                gapiInited = true;
                console.log("GAPI client initialized.");
                maybeEnableButtons();
            } catch (error) {
                console.error("Error initializing GAPI client:", error);
                authStatus.textContent = "Error: Could not initialize Google API client.";
                authStatus.classList.add('text-red-400');
            }
        }

        function gisLoaded() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: '', // Will be defined dynamically in handleAuthClick
                });
                gisInited = true;
                console.log("GIS client initialized.");
                maybeEnableButtons();
            } catch (error) {
                console.error("Error initializing GIS client:", error);
                authStatus.textContent = "Error: Could not initialize Google Sign-In.";
                authStatus.classList.add('text-red-400');
            }
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                authorizeButton.disabled = false;
                authStatus.textContent = "Ready to authenticate with Google Drive";
                console.log("Authentication system ready.");
            }
        }

        // --- AUTH LOGIC ---
        authorizeButton.onclick = handleAuthClick;
        signoutButton.onclick = handleSignoutClick;

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    console.error("Authentication error:", resp);
                    authStatus.textContent = `Auth Error: ${resp.error_description || resp.error}`;
                    authStatus.classList.add('text-red-400');
                    return;
                }
                await postAuthSetup();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }

        async function postAuthSetup() {
            authStatus.textContent = 'Authorization successful! Setting up Drive folder...';
            authStatus.classList.remove('text-yellow-400');
            authStatus.classList.add('text-green-400');
            signoutButton.classList.remove('hidden');
            authorizeButton.classList.add('hidden');
            
            try {
                DRIVE_FOLDER_ID = await findOrCreateFolder('Gemini_Synapse_Offload');
                authStatus.textContent = `‚úÖ Setup complete. Ready to offload artifacts.`;
                driveStatus.textContent = `Drive folder: Gemini_Synapse_Offload`;
                
                // Enable chat functionality
                promptInput.disabled = false;
                sendButton.disabled = false;
                promptInput.placeholder = "Ask me anything! I'll help create content and save it to your Drive.";
                
                // Show and enable archive controls
                document.getElementById('archive-controls').classList.remove('hidden');
                enableArchiveFeatures();
                
            } catch (error) {
                authStatus.textContent = `Error setting up Drive folder: ${error.message}`;
                authStatus.classList.remove('text-green-400');
                authStatus.classList.add('text-red-400');
                console.error(error);
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                authStatus.textContent = 'Signed Out. Please sign in to use the workspace.';
                authStatus.classList.remove('text-green-400');
                authStatus.classList.add('text-yellow-400');
                driveStatus.textContent = '';
                signoutButton.classList.add('hidden');
                authorizeButton.classList.remove('hidden');
                DRIVE_FOLDER_ID = null;
                
                // Disable chat functionality
                promptInput.disabled = true;
                sendButton.disabled = true;
                promptInput.placeholder = "Please authenticate to start chatting...";
                
                // Hide archive controls
                document.getElementById('archive-controls').classList.add('hidden');
                disableArchiveFeatures();
            }
        }

        // --- ARCHIVE & DOWNLOAD FUNCTIONS ---
        function enableArchiveFeatures() {
            document.getElementById('download-current-chat').disabled = false;
            document.getElementById('download-all-drive-content').disabled = false;
            document.getElementById('bulk-download-interactions').disabled = false;
            document.getElementById('generate-summary-report').disabled = false;
        }

        function disableArchiveFeatures() {
            document.getElementById('download-current-chat').disabled = true;
            document.getElementById('download-all-drive-content').disabled = true;
            document.getElementById('bulk-download-interactions').disabled = true;
            document.getElementById('generate-summary-report').disabled = true;
        }

        async function downloadCurrentChat() {
            if (conversationHistory.length === 0) {
                alert('No conversation to download!');
                return;
            }

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `current-chat-${timestamp}.json`;
            
            const chatData = {
                exportType: 'current-chat',
                timestamp: new Date().toISOString(),
                conversationHistory: conversationHistory,
                metadata: {
                    totalMessages: conversationHistory.length,
                    exportedBy: 'Operation Offload',
                    version: '1.0'
                }
            };

            downloadJSON(chatData, filename);
            updateDownloadStatus(`Current chat exported as ${filename}`);
        }

        async function downloadAllDriveContent() {
            if (!DRIVE_FOLDER_ID) {
                alert('Drive folder not initialized!');
                return;
            }

            showProgress(true);
            updateProgress(0, 'Scanning Google Drive folder...');

            try {
                // Get all files from the Drive folder
                const files = await getAllDriveFiles();
                updateProgress(30, `Found ${files.length} files. Downloading content...`);

                const allContent = [];
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    updateProgress(30 + (50 * (i + 1)) / files.length, `Downloading: ${file.name}`);
                    
                    try {
                        const content = await downloadDriveFile(file.id);
                        allContent.push({
                            filename: file.name,
                            createdTime: file.createdTime,
                            modifiedTime: file.modifiedTime,
                            size: file.size,
                            content: content
                        });
                    } catch (error) {
                        console.warn(`Failed to download ${file.name}:`, error);
                        allContent.push({
                            filename: file.name,
                            createdTime: file.createdTime,
                            error: error.message
                        });
                    }
                }

                updateProgress(90, 'Preparing download package...');

                const archiveData = {
                    exportType: 'drive-archive',
                    timestamp: new Date().toISOString(),
                    folderName: 'Gemini_Synapse_Offload',
                    totalFiles: files.length,
                    files: allContent,
                    metadata: {
                        exportedBy: 'Operation Offload',
                        version: '1.0'
                    }
                };

                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `drive-archive-${timestamp}.json`;
                
                downloadJSON(archiveData, filename);
                updateProgress(100, `Complete! Downloaded ${files.length} files.`);
                updateDownloadStatus(`Drive archive exported as ${filename}`);

            } catch (error) {
                console.error('Error downloading drive content:', error);
                updateDownloadStatus(`Error: ${error.message}`, 'text-red-400');
            } finally {
                setTimeout(() => showProgress(false), 2000);
            }
        }

        async function bulkDownloadInteractions() {
            if (!DRIVE_FOLDER_ID) {
                alert('Drive folder not initialized!');
                return;
            }

            showProgress(true);
            updateProgress(0, 'Gathering all interaction data...');

            try {
                // Get all conversation files
                const files = await getAllDriveFiles();
                const conversationFiles = files.filter(file => 
                    file.name.includes('gemini-conversation') || 
                    file.name.includes('interaction') ||
                    file.name.includes('chat')
                );

                updateProgress(20, `Found ${conversationFiles.length} conversation files.`);

                const allInteractions = [];
                const summaryStats = {
                    totalFiles: conversationFiles.length,
                    totalMessages: 0,
                    dateRange: { earliest: null, latest: null },
                    topicSummary: [],
                    wordCount: 0
                };

                for (let i = 0; i < conversationFiles.length; i++) {
                    const file = conversationFiles[i];
                    updateProgress(20 + (60 * (i + 1)) / conversationFiles.length, 
                        `Processing: ${file.name}`);
                    
                    try {
                        const content = await downloadDriveFile(file.id);
                        const interaction = {
                            filename: file.name,
                            timestamp: file.createdTime,
                            content: content,
                            wordCount: content.split(/\s+/).length
                        };
                        
                        allInteractions.push(interaction);
                        summaryStats.totalMessages += (content.match(/USER:|ASSISTANT:/g) || []).length / 2;
                        summaryStats.wordCount += interaction.wordCount;
                        
                        // Update date range
                        const fileDate = new Date(file.createdTime);
                        if (!summaryStats.dateRange.earliest || fileDate < new Date(summaryStats.dateRange.earliest)) {
                            summaryStats.dateRange.earliest = file.createdTime;
                        }
                        if (!summaryStats.dateRange.latest || fileDate > new Date(summaryStats.dateRange.latest)) {
                            summaryStats.dateRange.latest = file.createdTime;
                        }
                        
                    } catch (error) {
                        console.warn(`Failed to process ${file.name}:`, error);
                    }
                }

                updateProgress(90, 'Generating comprehensive export...');

                // Create comprehensive export
                const bulkExport = {
                    exportType: 'bulk-interactions',
                    timestamp: new Date().toISOString(),
                    summary: summaryStats,
                    interactions: allInteractions,
                    currentSession: {
                        conversationHistory: conversationHistory,
                        messageCount: conversationHistory.length
                    },
                    metadata: {
                        exportedBy: 'Operation Offload',
                        version: '1.0',
                        exportMethod: 'bulk-download'
                    }
                };

                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `bulk-interactions-${timestamp}.json`;
                
                downloadJSON(bulkExport, filename);
                updateProgress(100, `Exported ${conversationFiles.length} interactions!`);
                updateDownloadStatus(`Bulk export completed: ${filename}`);

            } catch (error) {
                console.error('Error in bulk download:', error);
                updateDownloadStatus(`Error: ${error.message}`, 'text-red-400');
            } finally {
                setTimeout(() => showProgress(false), 2000);
            }
        }

        async function generateSummaryReport() {
            if (!DRIVE_FOLDER_ID) {
                alert('Drive folder not initialized!');
                return;
            }

            showProgress(true);
            updateProgress(0, 'Analyzing all content...');

            try {
                const files = await getAllDriveFiles();
                updateProgress(20, `Analyzing ${files.length} files...`);

                const report = {
                    exportType: 'summary-report',
                    timestamp: new Date().toISOString(),
                    overview: {
                        totalFiles: files.length,
                        totalSize: 0,
                        dateRange: { earliest: null, latest: null },
                        fileTypes: {}
                    },
                    statistics: {
                        conversationsCount: 0,
                        totalMessages: 0,
                        averageWordsPerMessage: 0,
                        mostActiveDay: null,
                        totalWordCount: 0
                    },
                    recentActivity: [],
                    fileDetails: []
                };

                let totalWords = 0;
                const dailyActivity = {};

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    updateProgress(20 + (70 * (i + 1)) / files.length, 
                        `Analyzing: ${file.name}`);

                    const fileDate = new Date(file.createdTime);
                    const dayKey = fileDate.toISOString().split('T')[0];
                    dailyActivity[dayKey] = (dailyActivity[dayKey] || 0) + 1;

                    // Update overview stats
                    report.overview.totalSize += parseInt(file.size) || 0;
                    
                    if (!report.overview.dateRange.earliest || fileDate < new Date(report.overview.dateRange.earliest)) {
                        report.overview.dateRange.earliest = file.createdTime;
                    }
                    if (!report.overview.dateRange.latest || fileDate > new Date(report.overview.dateRange.latest)) {
                        report.overview.dateRange.latest = file.createdTime;
                    }

                    // Analyze file type
                    const extension = file.name.split('.').pop().toLowerCase();
                    report.overview.fileTypes[extension] = (report.overview.fileTypes[extension] || 0) + 1;

                    // Add to recent activity (last 10 files)
                    if (report.recentActivity.length < 10) {
                        report.recentActivity.push({
                            name: file.name,
                            created: file.createdTime,
                            size: file.size
                        });
                    }

                    // Count conversations and messages
                    if (file.name.includes('gemini-conversation') || file.name.includes('chat')) {
                        report.statistics.conversationsCount++;
                        try {
                            const content = await downloadDriveFile(file.id);
                            const messageMatches = content.match(/USER:|ASSISTANT:/g) || [];
                            const messageCount = messageMatches.length;
                            report.statistics.totalMessages += messageCount;
                            
                            const words = content.split(/\s+/).length;
                            totalWords += words;
                        } catch (error) {
                            console.warn(`Could not analyze content of ${file.name}`);
                        }
                    }

                    report.fileDetails.push({
                        name: file.name,
                        created: file.createdTime,
                        modified: file.modifiedTime,
                        size: file.size,
                        type: extension
                    });
                }

                // Calculate final statistics
                report.statistics.totalWordCount = totalWords;
                report.statistics.averageWordsPerMessage = report.statistics.totalMessages > 0 
                    ? Math.round(totalWords / report.statistics.totalMessages) : 0;

                // Find most active day
                const mostActiveEntry = Object.entries(dailyActivity)
                    .sort(([,a], [,b]) => b - a)[0];
                report.statistics.mostActiveDay = mostActiveEntry 
                    ? { date: mostActiveEntry[0], fileCount: mostActiveEntry[1] } : null;

                // Sort recent activity by date
                report.recentActivity.sort((a, b) => new Date(b.created) - new Date(a.created));

                updateProgress(100, 'Report generated successfully!');

                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `summary-report-${timestamp}.json`;
                
                downloadJSON(report, filename);
                updateDownloadStatus(`Summary report generated: ${filename}`);

            } catch (error) {
                console.error('Error generating summary:', error);
                updateDownloadStatus(`Error: ${error.message}`, 'text-red-400');
            } finally {
                setTimeout(() => showProgress(false), 2000);
            }
        }

        // --- HELPER FUNCTIONS FOR DOWNLOADS ---
        async function getAllDriveFiles() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `parents in '${DRIVE_FOLDER_ID}' and trashed=false`,
                    fields: 'files(id, name, createdTime, modifiedTime, size)',
                    orderBy: 'createdTime desc'
                });
                return response.result.files || [];
            } catch (error) {
                throw new Error(`Failed to list files: ${error.message}`);
            }
        }

        async function downloadDriveFile(fileId) {
            try {
                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });
                return response.body;
            } catch (error) {
                throw new Error(`Failed to download file: ${error.message}`);
            }
        }

        function downloadJSON(data, filename) {
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showProgress(show) {
            const progressDiv = document.getElementById('download-progress');
            if (show) {
                progressDiv.classList.remove('hidden');
            } else {
                progressDiv.classList.add('hidden');
            }
        }

        function updateProgress(percent, text) {
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-text').textContent = text;
        }

        function updateDownloadStatus(message, className = 'text-green-400') {
            const statusDiv = document.getElementById('download-status');
            statusDiv.textContent = message;
            statusDiv.className = `text-sm ${className}`;
        }

        // --- GOOGLE DRIVE FUNCTIONS ---
        async function findOrCreateFolder(folderName) {
            try {
                // Search for existing folder
                const searchResponse = await gapi.client.drive.files.list({
                    q: `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    fields: 'files(id, name)'
                });

                if (searchResponse.result.files && searchResponse.result.files.length > 0) {
                    console.log(`Found existing folder: ${folderName}`);
                    return searchResponse.result.files[0].id;
                }

                // Create new folder if it doesn't exist
                const createResponse = await gapi.client.drive.files.create({
                    resource: {
                        name: folderName,
                        mimeType: 'application/vnd.google-apps.folder'
                    },
                    fields: 'id'
                });

                console.log(`Created new folder: ${folderName}`);
                return createResponse.result.id;
            } catch (error) {
                console.error('Error with Drive folder:', error);
                throw new Error(`Failed to setup Drive folder: ${error.message}`);
            }
        }

        async function saveToGoogleDrive(content, filename) {
            if (!DRIVE_FOLDER_ID) {
                throw new Error('Drive folder not initialized');
            }

            try {
                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\r\n";
                const close_delim = "\r\n--" + boundary + "--";

                const metadata = {
                    name: filename,
                    parents: [DRIVE_FOLDER_ID]
                };

                const multipartRequestBody =
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(metadata) +
                    delimiter +
                    'Content-Type: text/plain\r\n\r\n' +
                    content +
                    close_delim;

                const request = gapi.client.request({
                    path: 'https://www.googleapis.com/upload/drive/v3/files',
                    method: 'POST',
                    params: { uploadType: 'multipart' },
                    headers: {
                        'Content-Type': `multipart/related; boundary="${boundary}"`
                    },
                    body: multipartRequestBody
                });

                const response = await request;
                console.log('File saved to Drive:', response.result);
                return response.result;
            } catch (error) {
                console.error('Error saving to Drive:', error);
                throw new Error(`Failed to save to Drive: ${error.message}`);
            }
        }

        // --- GEMINI AI FUNCTIONS ---
        async function callGeminiAPI(message) {
            try {
                const response = await fetch(`${GEMINI_ENDPOINT}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: message }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topP: 0.8,
                            topK: 40,
                            maxOutputTokens: 2048,
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error ${response.status}: ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('Invalid response format from Gemini API');
                }

                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error('Gemini API Error:', error);
                throw error;
            }
        }

        // --- CHAT FUNCTIONS ---
        const addMessage = (htmlContent, isUser = false) => {
            const bubble = document.createElement('div');
            bubble.className = `w-full flex ${isUser ? 'justify-end' : 'justify-start'}`;
            const contentWrapper = document.createElement('div');
            contentWrapper.className = `p-3 rounded-lg max-w-[90%] ${isUser ? 'chat-bubble-user' : 'chat-bubble-ai'}`;
            contentWrapper.innerHTML = htmlContent;
            bubble.appendChild(contentWrapper);
            chatWindow.appendChild(bubble);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return contentWrapper; // Return reference for updates
        };

        const sendMessage = async () => {
            if (isProcessing) return;
            
            const prompt = promptInput.value.trim();
            if (!prompt) return;

            if (!gapi.client.getToken() || !DRIVE_FOLDER_ID) {
                addMessage('<p class="text-red-400">Please authenticate with Google Drive first.</p>');
                return;
            }

            isProcessing = true;
            sendButton.disabled = true;
            sendButton.textContent = 'Processing...';

            // Add user message
            addMessage(`<p>${escapeHtml(prompt)}</p>`, true);
            promptInput.value = '';
            
            // Add loading message
            const loadingMessage = addMessage('<p><span class="loading-dots">Thinking</span></p>');

            try {
                // Build context from conversation history
                let contextMessage = prompt;
                if (conversationHistory.length > 0) {
                    const recentHistory = conversationHistory.slice(-4); // Last 4 exchanges
                    const contextParts = recentHistory.map(item => 
                        `${item.role}: ${item.content}`
                    ).join('\n');
                    contextMessage = `Previous context:\n${contextParts}\n\nCurrent message: ${prompt}`;
                }

                // Get AI response
                const aiResponse = await callGeminiAPI(contextMessage);
                
                // Update conversation history
                conversationHistory.push({ role: 'user', content: prompt });
                conversationHistory.push({ role: 'assistant', content: aiResponse });

                // Update the loading message with the actual response
                loadingMessage.innerHTML = `<p>${formatAIResponse(aiResponse)}</p>`;

                // Save conversation to Drive
                await saveConversationToDrive();

                // Show success indicator briefly
                const successIndicator = document.createElement('div');
                successIndicator.className = 'text-green-400 text-xs mt-2';
                successIndicator.textContent = '‚úì Saved to Google Drive';
                loadingMessage.appendChild(successIndicator);

            } catch (error) {
                console.error('Error processing message:', error);
                loadingMessage.innerHTML = `<p class="text-red-400">Error: ${escapeHtml(error.message)}</p>`;
            } finally {
                isProcessing = false;
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
            }
        };

        async function saveConversationToDrive() {
            try {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `gemini-conversation-${timestamp}.txt`;
                
                let conversationText = "Operation Offload - Gemini Conversation\n";
                conversationText += `Generated: ${new Date().toLocaleString()}\n`;
                conversationText += "=" .repeat(50) + "\n\n";
                
                conversationHistory.forEach((item, index) => {
                    conversationText += `${item.role.toUpperCase()}: ${item.content}\n\n`;
                });

                await saveToGoogleDrive(conversationText, filename);
                console.log('Conversation saved to Drive');
            } catch (error) {
                console.error('Error saving conversation:', error);
                // Don't throw error - conversation saving is supplementary
            }
        }

        function formatAIResponse(text) {
            // Basic formatting for AI responses
            return escapeHtml(text)
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code class="bg-gray-600 px-1 rounded">$1</code>')
                .replace(/\n/g, '<br>');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // --- EVENT LISTENERS ---
        sendButton.addEventListener('click', sendMessage);
        
        promptInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-resize textarea
        promptInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });

        // Archive & Download event listeners
        document.getElementById('download-current-chat').addEventListener('click', downloadCurrentChat);
        document.getElementById('download-all-drive-content').addEventListener('click', downloadAllDriveContent);
        document.getElementById('bulk-download-interactions').addEventListener('click', bulkDownloadInteractions);
        document.getElementById('generate-summary-report').addEventListener('click', generateSummaryReport);

        // Initialize conversation history
        conversationHistory = [];
        
        console.log("Operation Offload initialized with full archive capabilities!");
    </script>
</body>
</html>
