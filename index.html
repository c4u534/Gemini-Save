<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operation Offload: Intelligent Workspace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f3f4f6; }
        .chat-bubble-user { background-color: #1f2937; }
        .chat-bubble-ai { background-color: #374151; }
        .code-block { font-family: 'Roboto Mono', monospace; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-white">Operation Offload</h1>
            <p class="mt-2 max-w-2xl mx-auto text-lg text-gray-400">An intelligent workspace with automated artifact offloading to Google Drive.</p>
        </header>

        <div id="auth-section" class="bg-gray-800 shadow-xl rounded-lg p-6 mb-8 text-center">
            <h2 class="text-xl font-bold text-teal-400 mb-4">Authentication Status</h2>
            <p id="auth-status" class="text-yellow-400 mb-4">Awaiting Authentication...</p>
            <button id="authorize_button" disabled class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md disabled:bg-gray-500 disabled:cursor-not-allowed">Sign In with Google</button>
            <button id="signout_button" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Sign Out</button>
        </div>

        <div class="bg-gray-800 shadow-xl rounded-lg p-6">
            <div id="chat-window" class="h-96 overflow-y-auto bg-gray-900 p-4 rounded-lg border border-gray-700 mb-4 space-y-4">
                </div>

            <div class="flex items-center">
                <textarea id="prompt-input" class="flex-grow bg-gray-700 border-gray-600 rounded-l-md shadow-sm py-2 px-4 text-gray-200 focus:outline-none focus:ring-teal-500 focus:border-teal-500" placeholder="Send a message..." rows="1"></textarea>
                <button id="send-button" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-r-md self-stretch">Send</button>
            </div>
        </div>
    </div>

    <script src="/env-config.js"></script>
    <script async defer src="https://apis.google.com/js/api.js?onload=gapiLoaded"></script>
    <script async defer src="https://accounts.google.com/gsi/client?onload=gisLoaded"></script>

    <script>
        // --- CONFIGURATION ---
        // Configuration is now loaded from /env-config.js
        const CLIENT_ID = window.config ? window.config.CLIENT_ID : null;
        const API_KEY = window.config ? window.config.API_KEY : null;

        // --- DO NOT EDIT BELOW THIS LINE ---
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        let DRIVE_FOLDER_ID = null;

        const authorizeButton = document.getElementById('authorize_button');
        const signoutButton = document.getElementById('signout_button');
        const authStatus = document.getElementById('auth-status');
        const chatWindow = document.getElementById('chat-window');
        const promptInput = document.getElementById('prompt-input');
        const sendButton = document.getElementById('send-button');

        let gapiInited = false;
        let gisInited = false;
        let tokenClient;

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            if (!API_KEY) {
                console.error("API_KEY is missing. Check environment configuration.");
                authStatus.textContent = "Error: API Key is missing. Please check server environment configuration.";
                return;
            }
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
                });
                gapiInited = true;
                console.log("GAPI client initialized.");
                maybeEnableButtons();
            } catch (error) {
                console.error("Error initializing GAPI client:", error);
                authStatus.textContent = "Error: Could not initialize Google API client. Check API Key and configuration.";
            }
        }

        function gisLoaded() {
            if (!CLIENT_ID) {
                console.error("CLIENT_ID is missing. Check environment configuration.");
                authStatus.textContent = "Error: Client ID is missing. Please check server environment configuration.";
                return;
            }
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: '', 
                });
                gisInited = true;
                console.log("GIS client initialized.");
                maybeEnableButtons();
            } catch (error) {
                console.error("Error initializing GIS client:", error);
                authStatus.textContent = "Error: Could not initialize Google Sign-In. Check Client ID and Authorized Origins.";
            }
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                authorizeButton.disabled = false;
                console.log("Authentication buttons enabled.");
            }
        }

        window.gapiLoaded = gapiLoaded;
        window.gisLoaded = gisLoaded;

        authorizeButton.onclick = function() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    console.error("Authentication error:", resp);
                    authStatus.textContent = `Auth Error: ${resp.error}`;
                    return;
                }
                await postAuthSetup();
            };
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        };

        signoutButton.onclick = function() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                authStatus.textContent = 'Signed Out.';
                authStatus.classList.replace('text-green-400', 'text-yellow-400');
                signoutButton.classList.add('hidden');
                authorizeButton.classList.remove('hidden');
            }
        };
        
        async function postAuthSetup() {
            authStatus.textContent = 'Authorization successful! Setting up Drive folder...';
            authStatus.classList.replace('text-yellow-400', 'text-green-400');
            signoutButton.classList.remove('hidden');
            authorizeButton.classList.add('hidden');
            try {
                DRIVE_FOLDER_ID = await findOrCreateFolder('Gemini_Synapse_Offload');
                authStatus.textContent = `Setup complete. Ready to offload to folder: "Gemini_Synapse_Offload"`;
            } catch (error) {
                authStatus.textContent = `Error setting up Drive folder: ${error.message}`;
                console.error(error);
            }
        }
        
        // --- CORE APPLICATION LOGIC ---
        const addMessage = (htmlContent, isUser = false) => {
            const bubble = document.createElement('div');
            bubble.className = `w-full flex ${isUser ? 'justify-end' : 'justify-start'}`;
            const content = document.createElement('div');
            content.className = `p-3 rounded-lg max-w-[90%] ${isUser ? 'chat-bubble-user' : 'chat-bubble-ai'}`;
            content.innerHTML = htmlContent;
            bubble.appendChild(content);
            chatWindow.appendChild(bubble);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        };

        const sendMessage = async () => {
             const prompt = promptInput.value.trim();
             if (!prompt) return;
             addMessage(`<p>${prompt}</p>`, true);
             promptInput.value = '';
             addMessage('<p>Thinking...</p>');
             const aiResponse = `<p>Here is an artifact. I will now offload it.</p>
http://googleusercontent.com/immersive_entry_chip/0
`;
             await processAndOffload(aiResponse);
        };
        
        async function processAndOffload(responseHtml) {
            if (!gapi.client.getToken()) {
                const bubble = chatWindow.lastElementChild;
                if (bubble) {
                    const contentDiv = bubble.querySelector('div');
                    if (contentDiv) {
                        contentDiv.innerHTML = '<p class="text-red-400">Authentication required. Please sign in.</p>';
                    }
                }
                return;
            }

            const immersiveRegex = /\nhttp:\/\/googleusercontent\.com\/immersive_entry_chip\/(\d+)/;
            const match = responseHtml.match(immersiveRegex);

            let displayHtml = responseHtml;
            let artifactId = null;

            if (match) {
                // If a chip is found, remove it from the display HTML
                displayHtml = responseHtml.replace(immersiveRegex, '');
                artifactId = match[1];
                console.log(`Artifact chip detected: ID ${artifactId}`);
            }

            // Update the chat bubble (replace "Thinking...")
            const bubble = chatWindow.lastElementChild;
            if (bubble) {
                const contentDiv = bubble.querySelector('div');
                if (contentDiv) {
                    contentDiv.innerHTML = displayHtml;
                }
            } else {
                addMessage(displayHtml);
            }

            // If an artifact was detected, offload it to Drive
            if (artifactId !== null && DRIVE_FOLDER_ID) {
                try {
                    // Create a file in Drive
                    const fileMetadata = {
                        'name': `Synapse_Artifact_${artifactId}_${new Date().toISOString()}.html`,
                        'parents': [DRIVE_FOLDER_ID]
                    };

                    const boundary = '-------314159265358979323846';
                    const delimiter = "\r\n--" + boundary + "\r\n";
                    const close_delim = "\r\n--" + boundary + "--";

                    const metadata = JSON.stringify(fileMetadata);

                    const multipartRequestBody =
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        metadata +
                        delimiter +
                        'Content-Type: text/html\r\n\r\n' +
                        displayHtml +
                        close_delim;

                    const request = gapi.client.request({
                        'path': '/upload/drive/v3/files',
                        'method': 'POST',
                        'params': {'uploadType': 'multipart'},
                        'headers': {
                            'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                        },
                        'body': multipartRequestBody
                    });

                    const response = await request;
                    console.log('Artifact offloaded:', response.result.id);

                    addMessage(`<p class="text-xs text-green-400 mt-2">✓ Artifact offloaded to Drive (ID: ${response.result.id})</p>`);

                } catch (error) {
                    console.error('Error offloading artifact:', error);
                    addMessage(`<p class="text-xs text-red-400 mt-2">⚠ Error offloading artifact: ${error.message}</p>`);
                }
            }
        }

        async function findOrCreateFolder(folderName) {
            try {
                const q = `mimeType='application/vnd.google-apps.folder' and name='${folderName}' and trashed=false`;
                const response = await gapi.client.drive.files.list({
                    q: q,
                    fields: 'files(id, name)',
                });
                const files = response.result.files;
                if (files && files.length > 0) {
                    console.log(`Found existing folder: ${folderName} (${files[0].id})`);
                    return files[0].id;
                } else {
                    console.log(`Creating new folder: ${folderName}`);
                    const fileMetadata = {
                        'name': folderName,
                        'mimeType': 'application/vnd.google-apps.folder'
                    };
                    const file = await gapi.client.drive.files.create({
                        resource: fileMetadata,
                        fields: 'id'
                    });
                    console.log(`Created folder: ${folderName} (${file.result.id})`);
                    return file.result.id;
                }
            } catch (error) {
                console.error('Error in findOrCreateFolder:', error);
                throw error;
            }
        }

        sendButton.onclick = sendMessage;
    </script>
</body>
</html>
